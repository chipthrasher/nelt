<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Interactive Nelt Map</title>
    <script src="leaflet/leaflet.js"></script>
    <script src="leaflet/coords.js"></script>
    <script src="https://kit.fontawesome.com/64fcc6f5cf.js" crossorigin="anonymous"></script>
    <meta property="og:title" content="Interactive Nelt Map">
    <meta property="og:site_name" content="chipthrasher.com">
    <meta property="og:url" content="chipthrasher.com">
    <meta property="og:description" content="An interactive map of the Nelt (Nether highway) for the LGSMC  political Minecraft server.">
    <meta property="og:image" content="https://repository-images.githubusercontent.com/257634653/b98f6b00-d7c3-11ea-940c-6ec0402654f5">
    <link rel="icon" href="favicon.png" type="image/png"/>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="left">
      <div id="layers" class="layers"></div>
    </div>
    <div class="right">
      <div class="top">
        <div class="title"><a href="">Nelt Map</a></div>
        <div class="searchbox"><input class="search" placeholder="Search for a stop"><span class="clear" title="Clear search"><i class="fas fa-times"></i></span></div>
        <div class="subtitle">Tap on an exit to learn more.</div>
      </div>
      <div class="directory"></div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="leaflet/scroll.js"></script>
    <script>
      $(document).ready(function(e) {
        var exits = {}, content = '', directory = '';
        var colors = {
          "Montrose": "f1c40f",
          "NÃ³tos": "086F85",
          "Ozai": "7CDCE7",
          "Wohlstand": "3498DB",
          "Episkopija":"E9D4FF",
          "Syltheim":"ED8D18",
          "Goomlandia":"71368A",
          "Championis":"FFA846",
          "Fianna":"2C7D47",
          "HUM":"40A3FC",
          "Emerald Enclave":"50C878",
          "Emeraldia":"00ff00",
          "Fauxford":"030101",
          "Vailan":"100966",
          "Stradova":"4169e1",
          "Jericho":"5E60E6",
          "Kaab":"EBD785",
          "Krosnox":"555C45",
          "Vostok":"EB1C24",
          "Oberos":"9B59B6",
          "Obios":"B34343",
          "IBWH":"FFFFFF",
          "UAC":"A18B2B"
        };

        $('.itemcontent i').tooltip();
        $('.itemcontent i').hide(0);
        $('.wiki').hide(0);

        // Random color function
        const randomColor = () => {
           let color = '#';
           for (let i = 0; i < 6; i++){
              const random = Math.random();
              const bit = (random * 16) | 0;
              color += (bit).toString(16);
           };
           return color;
        };

        $.getJSON("data.json", function(data) {

          /* Generate map content */

          $.each(data, function(name, info) {

            if(info['Hide'] == 1) return;

            var x = info['X'],
                z = info['Z'],
                specialX = info['X Connector'],
                specialZ = info['Z Connector'],
                tempColor = '',
                tempIcons = '',
                tempWiki = '';

            exits[name] = info;

            /* Render SVG circles */

            content += `<circle class="circle" data-name="${name}" r="4" cx="${375 + x}" cy="${375 + z}" title/>`;

            if(colors[info['Political Entity']]) { // Set up itemright square color
              tempColor = '#' + colors[info['Political Entity']];
            } else tempColor = '';

            if(info['Wiki URL']) {
              tempWiki = `<div><a class="wiki" href="${info['Wiki URL']}">Read more on the Wiki</a></div>`;
            } else tempWiki = '';

            if(info['National'] == 1) tempIcons += '<i class="nation fas fa-flag" title="This is the official exit for its nation or political entity."></i>';

            if(info['End'] == 1) tempIcons += '<i class="end fas fa-atom" title="This exit leads to a public-access End Portal."></i>';

            if(info['IBWH'] == 1) tempIcons += '<i class="ibwh fas fa-globe" title="This exit is designated as an official IBWH site."></i>';

            if(info['Warning']) tempIcons += `<i class="warning fas fa-exclamation-triangle" title="${info['Warning']}"></i>`;

            directory += `<div class="item" data-name="${name}"><div class="itemtop"><div class="itemleft">${name}</div><div class="itemright" style="background: ${tempColor}">&nbsp;</div></div><div class="itemcontent"><div class="coords">${x}, ${z}</div><div class="entity">${info['Political Entity']}</div><div class="description">${info['Description']}</div>${tempWiki}<div>${tempIcons}</div></div></div>`;

            /* Render lines */

            if(specialX != '') {

              content +=`<line class="line" data-name="${name}" x1="${375 + x}" y1="${375 + z}" x2="${375 + specialX}" y2="${375 + z}"/>`;

            } else if(specialZ != '') {

              content +=`<line class="line" data-name="${name}" x1="${375 + x}" y1="${375 + z}" x2="${375 + x}" y2="${375 + specialZ}"/>`;

            } else {

              function findClosestX(num) {
                let lines = [-200,-100,0,100,200];
                let closestLine = lines[0];
                for(let item of lines) {
                  if(Math.abs(item - num) < Math.abs(closestLine - num)) closestLine = item;
                }
                return closestLine;
              }

              function findClosestZ(num) {
                let lines = [-200,-100,0,100,200,300];
                let closestLine = lines[0];
                for(let item of lines) {
                  if(Math.abs(item - num) < Math.abs(closestLine - num)) closestLine = item;
                }
                return closestLine;
              }

              if(Math.abs(x - findClosestX(x)) < Math.abs(z - findClosestZ(z))) {
                content +=`<line class="line" data-name="${name}" x1="${375 + x}" y1="${375 + z}" x2="${375 + findClosestX(x)}" y2="${375 + z}"/>`;
              } else {
                content +=`<line class="line" data-name="${name}" x1="${375 + x}" y1="${375 + z}" x2="${375 + x}" y2="${375 + findClosestZ(z)}"/>`;
              }
            }
          });

          /* Render map with Leaflet */

          var map = L.map('layers', {
            crs: L.CRS.Simple,
            zoom: -3,
            minZoom: -4,
            maxZoom: 0
          });

          var topleft = [-3000, -3000];
          var bottomright = [3000, 3000];

          // L.imageOverlay('dynmap.jpg', [topleft, bottomright], { className: 'dynmap', zIndex: 1 }).addTo(map);
          // L.imageOverlay('country.svg', [topleft, bottomright], { className: 'countries', zIndex: 2 }).addTo(map);
          L.imageOverlay('political.jpg', [topleft, bottomright], { className: 'political', zIndex: 1 }).addTo(map);
          L.imageOverlay('lines.svg', [topleft, bottomright], { className: 'lines', zIndex: 3 }).addTo(map);

          var svgElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          svgElement.setAttribute('viewBox', "0 0 750 750");
          svgElement.innerHTML = content;
          L.svgOverlay(svgElement, [topleft, bottomright], {
            interactive: true, zIndex: 5
          }).addTo(map);

          $('.directory').append(directory);
          $('.itemcontent i').tooltip();

          map.panTo([0, 0]);

          var c = new L.Control.Coordinates({
            position: 'topleft'
          });
          c.addTo(map);

          $('.leaflet-control-attribution').html('<b>Map opacity:</b><br><input type="range" min="0" max="0.5" step="0.01" value="0.15">');
          $('.leaflet-control-attribution input').mousemove(function() {
            $('.political').css('opacity', this.value);
          });

          map.on('mousemove', function(e) {
          	c.setCoordinates(e);
          });

          /* Create hover tooltips */

          $(".circle").tooltip({
            content: function() {
              var name = $(this).data('name'),
                  info = exits[name],
                  x = exits[name]['X'],
                  z = exits[name]['Z'];

              var content = `<div><div class="name">${name} <div class="coords">${x}, ${z}</div></div>`;
              return content;
            }
          });

          /* Display info on sidebar */

          $('.search').keyup(function() {
            $('.itemcontent').slideUp(0); // HIDE ANY OPEN CONTENT THAT MIGHT BE OPEN
            $('.circle').each(function() {
              var name = $(this).data('name');
              var searchString = `${name} ${exits[name]['X']} ${exits[name]['Z']} ${exits[name]['Political Entity']} ${exits[name]['Description']}`.toLowerCase();
              var thisString = $('.search').val().toLowerCase();
              var searchFlag = searchString.search(thisString);

              if(searchFlag == -1) {
                // console.log(`${thisString} NOT found in ${searchString}`);
                $(this).fadeOut(0);
              } else {
                // console.log(`${thisString} found at position ${searchFlag} in ${searchString}`);
                $(this).fadeIn(0);
              }
            });

            $('.line').each(function() {
              var name = $(this).data('name');
              var searchString = `${name} ${exits[name]['X']} ${exits[name]['Z']} ${exits[name]['Political Entity']} ${exits[name]['Description']}`.toLowerCase();
              var thisString = $('.search').val().toLowerCase();
              var searchFlag = searchString.search(thisString);

              if(searchFlag == -1) {
                // console.log(`${thisString} NOT found in ${searchString}`);
                $(this).fadeOut(0);
              } else {
                // console.log(`${thisString} found at position ${searchFlag} in ${searchString}`);
                $(this).fadeIn(0);
              }
            });

            $('.item').each(function() {
              var name = $(this).data('name');
              var searchString = `${name} ${exits[name]['X']} ${exits[name]['Z']} ${exits[name]['Political Entity']} ${exits[name]['Description']}`.toLowerCase();
              var thisString = $('.search').val().toLowerCase();
              var searchFlag = searchString.search(thisString);

              if(searchFlag == -1) {
                // console.log(`${thisString} NOT found in ${searchString}`);
                $(this).fadeOut(0);
              } else {
                // console.log(`${thisString} found at position ${searchFlag} in ${searchString}`);
                $(this).fadeIn(0);
              }
            });
          });

          // UPDATE THE SIDEBAR WITH STOP INFO!!!
          $('.circle').click(function() {
            var name = $(this).data('name');
            if($(`.item[data-name="${name}"]`).children('.itemcontent').css('display') != 'none') {
            } else {
              $('.search').val($(this).data('name'));
              $('.search').trigger('keyup');
              $(`.item[data-name="${name}"]`).children('.itemtop').trigger('click');
            }
          });

          $('.itemtop').click(function() {
            if($(this).siblings('.itemcontent').css('display') != 'none') {
              // It's open, so close it
              $(this).siblings('.itemcontent').slideUp(300);
            } else {
              // It's closed, so close everything else and open it
              $('.itemcontent').slideUp(300);
              $(this).siblings('.itemcontent').slideDown(300);
            };
          });

          $('.entity').click(function() { // Show all portals of same country
            $('.search').val(exits[$(this).parent().parent().data('name')]['Political Entity']);
            $('.search').trigger('keyup');
          });

          $('.clear').click(function() {
            $('.search').val('').trigger('keyup').focus();
          });
        });
      });
    </script>
  </body>
</html>
